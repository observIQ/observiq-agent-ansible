name: Integration Tests
on: 
  push:
    branches:
      - master
  pull_request:
jobs:
  integration:
    name: Molecule
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout the codebase.
        uses: actions/checkout@v2

      - name: Install Gcloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Install Gcloud Service Account's SSH Key
        run: |
          mkdir -p ~/.ssh
          'echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa'
          'echo "$SSH_PUBLIC_KEY" > ~/.ssh/id_rsa.pub'
          chmod -R 0600 ~/.ssh
        shell: bash
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Set up Python 3.
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Cache Pip modules
        uses: actions/cache@v2
        with:
          path: ~/.cache/pip
          # Cache will reset when requirements.txt is updated
          key: ${{ hashFiles('requirements.txt') }}

      - name: Install Pip Modules.
        run: |
          pip install -r requirements.txt
          echo "${HOME}/.local/bin" >> $GITHUB_PATH

      - name: Run Molecule tests.
        run: make test

      - name: Cleanup test instances
        run: make clean
        if: ${{ always() }}
---
name: Continuous Integration
on:
  pull_request:
  push:
    branches:
      - master
      - ci

jobs:

  test:
    name: Molecule
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        agent_type:
          - observiq-agent
        #scenario:
        #  - install_agent
        #  - uninstall_agent
        version:
          - 1.3.8
        distro:
          - geerlingguy/docker-centos7-ansible
          #- geerlingguy/docker-centos8-ansible
          # RedHat Universal Base Image (rhel8)
          #- geerlingguy/docker-ubi8-ansible
          #- geerlingguy/docker-amazonlinux2-ansible
          #- geerlingguy/docker-debian9-ansible
          #- geerlingguy/docker-debian10-ansible
          #- geerlingguy/docker-ubuntu1604-ansible
          #- geerlingguy/docker-ubuntu1804-ansible
          #- geerlingguy/docker-ubuntu2004-ansible

    steps:
      - name: Checkout the codebase.
        uses: actions/checkout@v2

      - name: Install SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          echo "$SSH_PUBLIC_KEY" > ~/.ssh/id_rsa.pub
          chmod 0600 ~/.ssh/*
        shell: bash
        env:
          SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
          SSH_PUBLIC_KEY: ${{secrets.SSH_PUBLIC_KEY}}

      - name: Install Gcloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          # raw project_id (no base64 encoding)
          project_id: ${{ secrets.PROJECT }}
          # raw json key file (no base64 encoding)
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Set up Python 3.
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install test dependencies.
        run: pip3 install ansible molecule[docker] docker yamllint ansible-lint google-auth

      - name: Run Molecule tests.
        run: molecule test -s ${{ matrix.agent_type }}
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
          MOLECULE_DISTRO: ${{ matrix.distro }}
          AGENT_TYPE: ${{ matrix.agent_type }}
          VERSION: ${{ matrix.version }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
---
- name: Create install directory tree
  file:
    # item is the loop value
    path: "{{ install_dir }}/{{ item }}"
    state: directory
    owner: "{{ service_user }}"
    group: "{{ service_user }}"
    mode: 0775
    # when recurse is enabled, config file mode will be set to 0775
    # which is a security risk
    recurse: false
  loop:
    - 'config'
    - 'launcher'
    - 'log'
    - 'log_agent'
    - 'manager'
    - 'manager/current'
    - 'manager/previous'
    - 'manager/previous/current'

- name: Create service file
  template:
    src: "observiq-agent.service"
    dest: "/etc/systemd/system/{{ service_name }}.service"
    mode: 0644

- name: Register manager
  stat:
    path: "{{ install_dir }}/manager/current/bpagent-manager-linux-amd64"
  register: manager
  changed_when: false

- name: Check manager version
  command: "{{ install_dir }}/manager/current/bpagent-manager-linux-amd64 --version"
  when: manager.stat.exists
  register: manager_version
  changed_when: false

- name: Install agent manager
  get_url:
    url: "https://storage.googleapis.com/observiq-cloud/observiq-agent/{{ version }}/artifacts/bpagent-manager-linux-amd64"
    dest: "{{ install_dir }}/manager/current/bpagent-manager-linux-amd64"
    owner: "{{ service_user }}"
    group: "{{ service_user }}"
    mode: 0755
  notify:
    - "restart {{ agent_type }} agent"
    - "install plugins"
  when: ( not manager.stat.exists )
    or ( version != manager_version.stdout)

- name: "Install agent launcher"
  get_url:
    url: "https://storage.googleapis.com/observiq-cloud/observiq-agent/{{ version }}/artifacts/bpagent-launcher-linux-amd64"
    dest: "{{ install_dir }}/launcher/bpagent-launcher-linux-amd64"
    owner: "{{ service_user }}"
    group: "{{ service_user }}"
    mode: 0755
  notify: "restart {{ agent_type }} agent"

- name: "Register plugins"
  stat:
    path: "{{ install_dir }}/log_agent/plugins"
  register: plugin_dir

- name: "Install plugins"
  command: "echo 'installing plugins'"
  when: not plugin_dir.stat.exists
  notify:
    - "restart {{ agent_type }} agent"
    - "download and install plugins"

# Store configuration options as a json file, changes to
# this file will trigger an update to remote.yaml
- name: Create config/remote.json
  template:
    src: "remote.json"
    dest: "{{ install_dir }}/config/remote.json"
    mode: 0600
  register: remote_json
  notify: "create config/remote.yaml"

- name: Create config/logging.yaml
  template:
    src: "logging.yaml"
    dest: "{{ install_dir }}/config/logging.yaml"
    mode: 0600
  notify: "restart {{ agent_type }} agent"

- name: Create config/os.yaml
  template:
    src: "os.yaml"
    dest: "{{ install_dir }}/config/os.yaml"
    mode: 0600
  notify: "restart {{ agent_type }} agent"
